{% extends "base.html" %}

{% block title %}Conexão com WhatsApp Web{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card shadow">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fab fa-whatsapp me-2"></i>Conectar com WhatsApp Web</h5>
        </div>
        <div class="card-body">
            <div class="text-center py-3">
                <h3>Escaneie o Código QR para Conectar</h3>
                <p class="text-muted">Use seu aplicativo do WhatsApp para escanear este código QR</p>
                
                <div class="alert alert-primary" role="alert">
                    <h5><i class="fas fa-info-circle me-2"></i>Como funciona a integração com WhatsApp</h5>
                    <p class="mb-1">Este sistema utiliza automação do navegador para conectar-se ao WhatsApp Web, permitindo:</p>
                    <ul class="text-start">
                        <li>Escaneie o código QR apenas uma vez para conectar sua conta</li>
                        <li>Envie mensagens em massa para múltiplos contatos</li>
                        <li>Personalize mensagens com o nome de cada lead</li>
                        <li>Receba relatórios detalhados dos envios</li>
                    </ul>
                </div>
                
                <!-- O QR Code será exibido aqui - por enquanto mostramos apenas uma instrução -->
                <div class="mt-3 mb-4 p-4 border rounded d-inline-block">
                    <i class="fab fa-whatsapp fa-4x text-success mb-3"></i>
                    <div id="qr-placeholder" class="border p-5 mb-3 bg-light">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-3">Inicializando WhatsApp Web...</p>
                    </div>
                    
                    <p id="status-message" class="alert alert-info">
                        Aguardando o WhatsApp Web carregar... O navegador abrirá automaticamente.
                    </p>
                </div>
                
                <div class="card mt-4 mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Instruções para conexão</h5>
                    </div>
                    <div class="card-body text-start">
                        <ol>
                            <li>Abra o aplicativo WhatsApp no seu celular</li>
                            <li>Toque em <strong>Menu</strong> ou <strong>Configurações</strong></li>
                            <li>Selecione <strong>WhatsApp Web</strong> ou <strong>Aparelhos conectados</strong></li>
                            <li>Aponte a câmera para o código QR mostrado acima</li>
                            <li>Aguarde a confirmação de conexão e pronto!</li>
                        </ol>
                        <p class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Importante:</strong> Mantenha este site aberto durante o envio de mensagens. Fechar o navegador interromperá a conexão com WhatsApp Web.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{{ url_for('leads') }}" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Voltar para Leads
                </a>
                <a href="{{ url_for('whatsapp_bulk') }}" class="btn btn-success">
                    <i class="fab fa-whatsapp me-2"></i>Ir para Envio em Massa
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const qrPlaceholder = document.getElementById('qr-placeholder');
        const statusMessage = document.getElementById('status-message');
        let sessionInterval = null;
        
        // Iniciar o processo de conexão
        startWhatsAppSession();
        
        // Função para iniciar a sessão do WhatsApp
        function startWhatsAppSession() {
            statusMessage.textContent = "Iniciando o WhatsApp Web...";
            statusMessage.className = "alert alert-info";
            
            // Chamada ao endpoint para iniciar o processo
            fetch('/api/whatsapp/start-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Session start response:', data);
                
                if (data.status === 'initiated') {
                    // Iniciar o monitoramento da sessão
                    sessionInterval = setInterval(checkSessionStatus, 2000);
                    statusMessage.textContent = data.message;
                } else {
                    statusMessage.textContent = data.message || "Erro ao iniciar WhatsApp Web";
                    statusMessage.className = "alert alert-danger";
                }
            })
            .catch(error => {
                console.error('Error starting session:', error);
                statusMessage.textContent = "Erro ao conectar com o servidor. Tente novamente mais tarde.";
                statusMessage.className = "alert alert-danger";
            });
        }
        
        // Função para verificar o status da sessão
        function checkSessionStatus() {
            fetch('/api/whatsapp/session-status')
            .then(response => response.json())
            .then(data => {
                console.log('Session status:', data);
                
                statusMessage.textContent = data.message;
                
                if (data.status === 'connected') {
                    // Sessão conectada com sucesso
                    clearInterval(sessionInterval);
                    statusMessage.className = "alert alert-success";
                    qrPlaceholder.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                            <h4>Conectado com sucesso!</h4>
                            <p>Você já pode enviar mensagens automáticas pelo WhatsApp.</p>
                        </div>
                    `;
                    
                    // Redirecionar após 3 segundos
                    setTimeout(() => {
                        window.location.href = "{{ url_for('whatsapp_bulk') }}";
                    }, 3000);
                    
                } else if (data.status === 'error') {
                    // Erro na sessão
                    clearInterval(sessionInterval);
                    statusMessage.className = "alert alert-danger";
                    qrPlaceholder.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle text-danger fa-4x mb-3"></i>
                            <h4>Erro ao conectar</h4>
                            <p>Ocorreu um erro ao tentar conectar com o WhatsApp Web.</p>
                            <button class="btn btn-primary mt-3" onclick="window.location.reload()">
                                <i class="fas fa-sync me-2"></i>Tentar Novamente
                            </button>
                        </div>
                    `;
                    
                } else if (data.qr_status === 'ready') {
                    // Simular exibição de um QR code (em uma implementação real, seria a imagem do QR)
                    qrPlaceholder.innerHTML = `
                        <div class="text-center">
                            <div class="border rounded p-4 d-inline-block bg-white">
                                <!-- Placeholder para o QR code real -->
                                <div style="width: 200px; height: 200px; background-color: #f8f9fa;">
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://web.whatsapp.com" 
                                         alt="QR Code do WhatsApp" class="img-fluid">
                                </div>
                            </div>
                            <p class="mt-3 text-muted">Escaneie este código com o seu celular</p>
                        </div>
                    `;
                    statusMessage.className = "alert alert-warning";
                }
            })
            .catch(error => {
                console.error('Error checking session status:', error);
            });
        }
    });
</script>
{% endblock %}